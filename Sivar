-- Rayfield 라이브러리 로드
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Window 생성
local Window = Rayfield:CreateWindow({
    Name = "동혁이 쓰려고 만든 핵",
    LoadingTitle = "동혁이 쓰려고 만든 핵",
    LoadingSubtitle = "by Rayfield",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "DongHyukHack",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "",
        RememberJoins = true
    },
    KeySystem = false
})

-- 메인 탭만 생성
local MainTab = Window:CreateTab("메인", "home")

---------------------------------------------------------------------------
-- 속도핵 관련 변수 및 함수
---------------------------------------------------------------------------
local speedEnabled = false
local speedValue = 50
local originalWalkSpeed = 16
local speedConnection = nil

local function setupSpeed()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    if speedEnabled then
        humanoid.WalkSpeed = speedValue
        
        if speedConnection then
            speedConnection:Disconnect()
        end
        
        speedConnection = game:GetService("RunService").RenderStepped:Connect(function()
            if speedEnabled and humanoid and humanoid.Parent then
                if humanoid.WalkSpeed ~= speedValue then
                    humanoid.WalkSpeed = speedValue
                end
            end
        end)
    else
        if speedConnection then
            speedConnection:Disconnect()
            speedConnection = nil
        end
        
        if humanoid and humanoid.Parent then
            humanoid.WalkSpeed = originalWalkSpeed
        end
    end
end

---------------------------------------------------------------------------
-- 점프핵 관련 변수 및 함수
---------------------------------------------------------------------------
local jumpEnabled = false
local jumpValue = 50
local originalJumpPower = 50
local jumpConnection = nil

local function setupJump()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    if jumpEnabled then
        humanoid.JumpPower = jumpValue
        humanoid.JumpHeight = jumpValue / 10
        
        if jumpConnection then
            jumpConnection:Disconnect()
        end
        
        jumpConnection = game:GetService("RunService").RenderStepped:Connect(function()
            if jumpEnabled and humanoid and humanoid.Parent then
                if humanoid.JumpPower ~= jumpValue then
                    humanoid.JumpPower = jumpValue
                    humanoid.JumpHeight = jumpValue / 10
                end
            end
        end)
    else
        if jumpConnection then
            jumpConnection:Disconnect()
            jumpConnection = nil
        end
        
        if humanoid and humanoid.Parent then
            humanoid.JumpPower = originalJumpPower
            humanoid.JumpHeight = originalJumpPower / 10
        end
    end
end

---------------------------------------------------------------------------
-- 플라이핵 관련 변수 및 함수
---------------------------------------------------------------------------
local flyEnabled = false
local flySpeed = 50
local flyBodyVelocity = nil
local flyConnection = nil

local function setupFly()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    
    if not humanoid or not rootPart then return end
    
    if flyEnabled then
        humanoid.PlatformStand = true
        
        if flyBodyVelocity then
            flyBodyVelocity:Destroy()
        end
        
        flyBodyVelocity = Instance.new("BodyVelocity")
        flyBodyVelocity.MaxForce = Vector3.new(1, 1, 1) * 1e9
        flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
        flyBodyVelocity.Parent = rootPart
        
        if flyConnection then
            flyConnection:Disconnect()
        end
        
        flyConnection = game:GetService("RunService").Heartbeat:Connect(function()
            if not (flyEnabled and rootPart and rootPart.Parent and flyBodyVelocity) then return end
            
            local moveDirection = Vector3.new(0, 0, 0)
            local camera = workspace.CurrentCamera
            local uis = game:GetService("UserInputService")
            
            if uis:IsKeyDown(Enum.KeyCode.W) then
                moveDirection = moveDirection + camera.CFrame.LookVector
            end
            if uis:IsKeyDown(Enum.KeyCode.S) then
                moveDirection = moveDirection - camera.CFrame.LookVector
            end
            if uis:IsKeyDown(Enum.KeyCode.A) then
                moveDirection = moveDirection - camera.CFrame.RightVector
            end
            if uis:IsKeyDown(Enum.KeyCode.D) then
                moveDirection = moveDirection + camera.CFrame.RightVector
            end
            if uis:IsKeyDown(Enum.KeyCode.Space) then
                moveDirection = moveDirection + Vector3.new(0, 1, 0)
            end
            if uis:IsKeyDown(Enum.KeyCode.LeftControl) then
                moveDirection = moveDirection + Vector3.new(0, -1, 0)
            end
            
            if moveDirection.Magnitude > 0 then
                moveDirection = moveDirection.Unit * flySpeed
            end
            
            flyBodyVelocity.Velocity = moveDirection
        end)
    else
        if flyBodyVelocity then
            flyBodyVelocity:Destroy()
            flyBodyVelocity = nil
        end
        if flyConnection then
            flyConnection:Disconnect()
            flyConnection = nil
        end
        if humanoid then
            humanoid.PlatformStand = false
        end
    end
end

---------------------------------------------------------------------------
-- 벽뚫핵 관련 변수 및 함수
---------------------------------------------------------------------------
local noclipEnabled = false
local noclipConnection = nil
local noclipParts = {}

local function setupNoclip()
    local player = game.Players.LocalPlayer
    local character = player.Character
    
    if noclipEnabled then
        if noclipConnection then
            noclipConnection:Disconnect()
        end
        
        if character then
            for _, v in pairs(character:GetDescendants()) do
                if v:IsA("BasePart") then
                    noclipParts[v] = v.CanCollide
                end
            end
        end
        
        noclipConnection = game:GetService("RunService").Stepped:Connect(function()
            if noclipEnabled then
                local player = game.Players.LocalPlayer
                local character = player.Character
                if character then
                    for _, v in pairs(character:GetDescendants()) do
                        if v:IsA("BasePart") then
                            v.CanCollide = false
                        end
                    end
                end
            end
        end)
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
        
        local player = game.Players.LocalPlayer
        local character = player.Character
        if character then
            for _, v in pairs(character:GetDescendants()) do
                if v:IsA("BasePart") then
                    if noclipParts[v] ~= nil then
                        v.CanCollide = noclipParts[v]
                    else
                        v.CanCollide = true
                    end
                end
            end
        end
        
        noclipParts = {}
    end
end

---------------------------------------------------------------------------
-- 무한점프 관련 변수 및 함수
---------------------------------------------------------------------------
local infiniteJumpEnabled = false
local infiniteJumpConnection = nil

local function setupInfiniteJump()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    if infiniteJumpEnabled then
        if infiniteJumpConnection then
            infiniteJumpConnection:Disconnect()
        end
        
        infiniteJumpConnection = game:GetService("UserInputService").JumpRequest:Connect(function()
            if infiniteJumpEnabled and humanoid and humanoid.Parent then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    else
        if infiniteJumpConnection then
            infiniteJumpConnection:Disconnect()
            infiniteJumpConnection = nil
        end
    end
end

---------------------------------------------------------------------------
-- 투명인간 관련 변수 및 함수 (완전히 개선됨)
---------------------------------------------------------------------------
local invisibleEnabled = false
local invisibleParts = {}  -- 모든 파트의 원본 데이터 저장

local function setupInvisible()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character then return end
    
    if invisibleEnabled then
        -- 투명핵 켜기: 모든 파트의 현재 상태 저장 후 투명하게
        invisibleParts = {}  -- 초기화
        
        -- 캐릭터의 모든 파트 수집 (몸통, 팔, 다리, 머리 등)
        for _, v in pairs(character:GetDescendants()) do
            if v:IsA("BasePart") or v:IsA("MeshPart") or v:IsA("Part") then
                -- 각 파트의 원본 데이터 저장
                invisibleParts[v] = {
                    Transparency = v.Transparency,
                    LocalTransparencyModifier = v.LocalTransparencyModifier,
                    Visible = v.Visible
                }
                
                -- 투명하게 설정 (다른 플레이어에게 안 보임)
                v.Transparency = 1
                -- 로컬에서는 보이게 (선택사항, 0으로 두면 나에게는 보임)
                v.LocalTransparencyModifier = 0
                v.Visible = true
            end
        end
        
        -- 액세서리(모자, 가방 등) 처리
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            for _, accessory in pairs(humanoid:GetAccessories()) do
                if accessory:IsA("Accessory") then
                    local handle = accessory:FindFirstChild("Handle")
                    if handle and handle:IsA("BasePart") then
                        -- 액세서리 핸들 저장
                        if not invisibleParts[handle] then
                            invisibleParts[handle] = {
                                Transparency = handle.Transparency,
                                LocalTransparencyModifier = handle.LocalTransparencyModifier,
                                Visible = handle.Visible
                            }
                        end
                        handle.Transparency = 1
                        handle.LocalTransparencyModifier = 0
                        handle.Visible = true
                    end
                    
                    -- 액세서리의 다른 파트들도 처리
                    for _, part in pairs(accessory:GetDescendants()) do
                        if part:IsA("BasePart") and part ~= handle then
                            if not invisibleParts[part] then
                                invisibleParts[part] = {
                                    Transparency = part.Transparency,
                                    LocalTransparencyModifier = part.LocalTransparencyModifier,
                                    Visible = part.Visible
                                }
                            end
                            part.Transparency = 1
                            part.LocalTransparencyModifier = 0
                            part.Visible = true
                        end
                    end
                end
            end
        end
        
        -- 옷/clothing 처리 (있다면)
        if character:FindFirstChild("Clothing") then
            for _, v in pairs(character.Clothing:GetDescendants()) do
                if v:IsA("BasePart") then
                    if not invisibleParts[v] then
                        invisibleParts[v] = {
                            Transparency = v.Transparency,
                            LocalTransparencyModifier = v.LocalTransparencyModifier,
                            Visible = v.Visible
                        }
                    end
                    v.Transparency = 1
                    v.LocalTransparencyModifier = 0
                end
            end
        end
        
        print("[투명핵] 활성화 - 저장된 파트 수: " .. table.count(invisibleParts))
        
    else
        -- 투명핵 끄기: 저장된 데이터로 정확히 복구
        local restoredCount = 0
        
        for part, data in pairs(invisibleParts) do
            if part and part.Parent then  -- 파트가 아직 존재하는지 확인
                part.Transparency = data.Transparency
                part.LocalTransparencyModifier = data.LocalTransparencyModifier
                part.Visible = data.Visible
                restoredCount = restoredCount + 1
            end
        end
        
        -- 저장된 데이터 초기화
        invisibleParts = {}
        
        print("[투명핵] 비활성화 - 복구된 파트 수: " .. restoredCount)
        
        -- 혹시 저장되지 않은 파트가 있다면 기본값으로 복구 (안전장치)
        local player = game.Players.LocalPlayer
        local character = player.Character
        if character then
            for _, v in pairs(character:GetDescendants()) do
                if v:IsA("BasePart") then
                    if v.Transparency == 1 then  -- 아직 투명한 파트가 있다면
                        v.Transparency = 0
                        v.LocalTransparencyModifier = 0
                    end
                end
            end
        end
    end
end

---------------------------------------------------------------------------
-- 프리즈 핵 관련 변수 및 함수
---------------------------------------------------------------------------
local freezeEnabled = false
local freezePosition = nil
local freezeBodyPosition = nil
local freezeConnection = nil

local function setupFreeze()
    local player = game.Players.LocalPlayer
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if not rootPart or not humanoid then return end
    
    if freezeEnabled then
        freezePosition = rootPart.Position
        
        if freezeBodyPosition then
            freezeBodyPosition:Destroy()
        end
        
        freezeBodyPosition = Instance.new("BodyPosition")
        freezeBodyPosition.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
        freezeBodyPosition.P = 10000
        freezeBodyPosition.D = 100
        freezeBodyPosition.Position = freezePosition
        freezeBodyPosition.Parent = rootPart
        
        if freezeConnection then
            freezeConnection:Disconnect()
        end
        
        freezeConnection = game:GetService("RunService").Heartbeat:Connect(function()
            if freezeEnabled and rootPart and rootPart.Parent and freezeBodyPosition then
                freezeBodyPosition.Position = freezePosition
            end
        end)
        
        humanoid.PlatformStand = true
    else
        if freezeBodyPosition then
            freezeBodyPosition:Destroy()
            freezeBodyPosition = nil
        end
        if freezeConnection then
            freezeConnection:Disconnect()
            freezeConnection = nil
        end
        if humanoid then
            humanoid.PlatformStand = false
        end
        freezePosition = nil
    end
end

---------------------------------------------------------------------------
-- 메인 탭 UI
---------------------------------------------------------------------------

-- 속도핵 섹션
local speedSection = MainTab:CreateSection("속도핵")

local speedToggle = MainTab:CreateToggle({
    Name = "속도핵",
    CurrentValue = false,
    Flag = "SpeedToggle",
    Callback = function(Value)
        speedEnabled = Value
        setupSpeed()
        
        if Value then
            Rayfield:Notify({
                Title = "속도핵",
                Content = "활성화되었습니다. (속도: " .. speedValue .. ")",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "속도핵",
                Content = "비활성화되었습니다.",
                Duration = 2
            })
        end
    end
})

local currentSpeedLabel = MainTab:CreateLabel("현재 속도: 50")

local speedSlider = MainTab:CreateSlider({
    Name = "속도 조절",
    Range = {1, 1000},
    Increment = 1,
    Suffix = "속도",
    CurrentValue = 50,
    Flag = "SpeedSlider",
    Callback = function(Value)
        speedValue = Value
        
        if currentSpeedLabel then
            currentSpeedLabel:Set("현재 속도: " .. Value)
        end
        
        if speedEnabled then
            local player = game.Players.LocalPlayer
            local character = player.Character
            if character then
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.WalkSpeed = Value
                end
            end
        end
    end
})

-- 플라이핵 섹션
local flySection = MainTab:CreateSection("플라이핵")

local flyToggle = MainTab:CreateToggle({
    Name = "플라이핵",
    CurrentValue = false,
    Flag = "FlyToggle",
    Callback = function(Value)
        flyEnabled = Value
        setupFly()
        
        if Value then
            Rayfield:Notify({
                Title = "플라이핵",
                Content = "활성화되었습니다. (WASD + 스페이스/컨트롤)",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "플라이핵",
                Content = "비활성화되었습니다.",
                Duration = 2
            })
        end
    end
})

local currentFlySpeedLabel = MainTab:CreateLabel("현재 플라이 속도: 50")

local flySpeedSlider = MainTab:CreateSlider({
    Name = "플라이 속도 조절",
    Range = {1, 1000},
    Increment = 1,
    Suffix = "속도",
    CurrentValue = 50,
    Flag = "FlySpeedSlider",
    Callback = function(Value)
        flySpeed = Value
        
        if currentFlySpeedLabel then
            currentFlySpeedLabel:Set("현재 플라이 속도: " .. Value)
        end
    end
})

-- 점프핵 섹션
local jumpSection = MainTab:CreateSection("점프핵")

local jumpToggle = MainTab:CreateToggle({
    Name = "점프핵",
    CurrentValue = false,
    Flag = "JumpToggle",
    Callback = function(Value)
        jumpEnabled = Value
        setupJump()
        
        if Value then
            Rayfield:Notify({
                Title = "점프핵",
                Content = "활성화되었습니다. (점프력: " .. jumpValue .. ")",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "점프핵",
                Content = "비활성화되었습니다.",
                Duration = 2
            })
        end
    end
})

local currentJumpLabel = MainTab:CreateLabel("현재 점프력: 50")

local jumpSlider = MainTab:CreateSlider({
    Name = "점프력 조절",
    Range = {1, 1000},
    Increment = 1,
    Suffix = "점프력",
    CurrentValue = 50,
    Flag = "JumpSlider",
    Callback = function(Value)
        jumpValue = Value
        
        if currentJumpLabel then
            currentJumpLabel:Set("현재 점프력: " .. Value)
        end
        
        if jumpEnabled then
            local player = game.Players.LocalPlayer
            local character = player.Character
            if character then
                local humanoid = character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.JumpPower = Value
                    humanoid.JumpHeight = Value / 10
                end
            end
        end
    end
})

-- 벽뚫핵 섹션
local noclipSection = MainTab:CreateSection("벽뚫핵")

local noclipToggle = MainTab:CreateToggle({
    Name = "벽뚫핵",
    CurrentValue = false,
    Flag = "NoclipToggle",
    Callback = function(Value)
        noclipEnabled = Value
        setupNoclip()
        
        if Value then
            Rayfield:Notify({
                Title = "벽뚫핵",
                Content = "활성화되었습니다. (바닥 제외 모든 벽 통과)",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "벽뚫핵",
                Content = "비활성화되었습니다.",
                Duration = 2
            })
        end
    end
})

-- 무한점프 섹션
local infiniteJumpSection = MainTab:CreateSection("무한점프")

local infiniteJumpToggle = MainTab:CreateToggle({
    Name = "무한점프",
    CurrentValue = false,
    Flag = "InfiniteJumpToggle",
    Callback = function(Value)
        infiniteJumpEnabled = Value
        setupInfiniteJump()
        
        if Value then
            Rayfield:Notify({
                Title = "무한점프",
                Content = "활성화되었습니다. (계속 점프 가능)",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "무한점프",
                Content = "비활성화되었습니다.",
                Duration = 2
            })
        end
    end
})

-- 투명인간 섹션 (완전히 개선됨)
local invisibleSection = MainTab:CreateSection("투명인간")

local invisibleToggle = MainTab:CreateToggle({
    Name = "투명인간",
    CurrentValue = false,
    Flag = "InvisibleToggle",
    Callback = function(Value)
        invisibleEnabled = Value
        setupInvisible()
        
        if Value then
            Rayfield:Notify({
                Title = "투명인간",
                Content = "활성화되었습니다. (완벽한 투명화)",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "투명인간",
                Content = "비활성화되었습니다. (원래대로 복구)",
                Duration = 2
            })
        end
    end
})

-- 프리즈 핵 섹션
local freezeSection = MainTab:CreateSection("프리즈 핵")

local freezeToggle = MainTab:CreateToggle({
    Name = "프리즈",
    CurrentValue = false,
    Flag = "FreezeToggle",
    Callback = function(Value)
        freezeEnabled = Value
        setupFreeze()
        
        if Value then
            Rayfield:Notify({
                Title = "프리즈 핵",
                Content = "활성화되었습니다. (현재 위치에 고정)",
                Duration = 2
            })
        else
            Rayfield:Notify({
                Title = "프리즈 핵",
                Content = "비활성화되었습니다. (고정 해제)",
                Duration = 2
            })
        end
    end
})

---------------------------------------------------------------------------
-- 캐릭터 변경 시 처리
---------------------------------------------------------------------------
game.Players.LocalPlayer.CharacterAdded:Connect(function(character)
    wait(1)
    
    local humanoid = character:WaitForChild("Humanoid", 5)
    if not humanoid then return end
    
    -- 원래 속도 저장
    originalWalkSpeed = 16
    
    -- 속도핵 재적용
    if speedEnabled then
        wait(0.2)
        humanoid.WalkSpeed = speedValue
        setupSpeed()
    end
    
    -- 점프핵 재적용
    if jumpEnabled then
        wait(0.2)
        humanoid.JumpPower = jumpValue
        humanoid.JumpHeight = jumpValue / 10
        setupJump()
    end
    
    -- 플라이핵 재적용
    if flyEnabled then
        wait(0.2)
        setupFly()
    end
    
    -- 벽뚫핵 재적용
    if noclipEnabled then
        wait(0.2)
        setupNoclip()
    end
    
    -- 무한점프 재적용
    if infiniteJumpEnabled then
        wait(0.2)
        setupInfiniteJump()
    end
    
    -- 투명인간 재적용
    if invisibleEnabled then
        wait(0.2)
        setupInvisible()
    end
    
    -- 프리즈 핵 재적용
    if freezeEnabled then
        wait(0.2)
        setupFreeze()
    end
end)

-- 테이블 크기 계산 함수 (디버그용)
function table.count(t)
    local count = 0
    for _ in pairs(t) do count = count + 1 end
    return count
end

---------------------------------------------------------------------------
-- 초기화 완료 알림
---------------------------------------------------------------------------
Rayfield:Notify({
    Title = "동혁이 쓰려고 만든 핵",
    Content = "투명핵이 완벽하게 개선되었습니다!",
    Duration = 4
})
