local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- [ 원본 파일 변수 및 리모트 설정 ]
local Players = game:GetService("Players")
local plr = Players.LocalPlayer
local rs = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local SetNetworkOwner = rs:WaitForChild("GrabEvents"):WaitForChild("SetNetworkOwner")

-- 보이드 높이 (파일 로직)
local FallenY = workspace.FallenPartsDestroyHeight
local targetY = (FallenY <= -50000 and -49999) or (FallenY <= -100 and -99) or -100

local Window = Rayfield:CreateWindow({
   Name = "FTAP 타겟 루프 스크립트",
   LoadingTitle = "파일 로직 이식 완료",
   LoadingSubtitle = "자동 대상 인식 모드",
   ConfigurationSaving = { Enabled = false }
})

local MainTab = Window:CreateTab("그랩 설정", 4483362458)

-- [ 변수 설정 ]
local AutoLoopTarget = nil -- 현재 자동으로 잡힌 대상
local IsAutoLoopEnabled = false

-- [ 핵심 로직: 내가 누군가를 잡으면 그 대상을 루프 타겟으로 지정 ]
task.spawn(function()
    RunService.Heartbeat:Connect(function()
        if not IsAutoLoopEnabled then return end
        
        -- 내가 누군가를 잡고 있는지 감지 (GrabParts 모델 확인)
        local grabParts = workspace:FindFirstChild("GrabParts")
        if grabParts then
            for _, gp in pairs(grabParts:GetChildren()) do
                -- 내가 생성한 그랩 파트인지 확인 (보통 본인의 그랩은 구분이 가능)
                local weld = gp:FindFirstChildOfClass("WeldConstraint")
                if weld and weld.Part1 and weld.Part1:IsDescendantOf(workspace) then
                    local model = weld.Part1:FindFirstAncestorOfClass("Model")
                    local targetPlr = Players:GetPlayerFromCharacter(model)
                    
                    if targetPlr and targetPlr ~= plr then
                        -- [자동 타겟팅] 방금 내가 잡은 유저를 루프 대상으로 고정
                        AutoLoopTarget = targetPlr
                    end
                end
            end
        end

        -- 타겟이 정해졌다면 무한 그랩 실행 (원본 SetNetworkOwner 로직)
        if AutoLoopTarget and AutoLoopTarget.Character and AutoLoopTarget.Character:FindFirstChild("HumanoidRootPart") then
            SetNetworkOwner:FireServer(AutoLoopTarget.Character.HumanoidRootPart)
        end
    end)
end)

-- [ UI 컴포넌트 ]

MainTab:CreateToggle({
   Name = "잡은 사람 무한 유지 (Auto Loop Grab)",
   CurrentValue = false,
   Callback = function(Value)
      IsAutoLoopEnabled = Value
      if not Value then
          AutoLoopTarget = nil -- 토글 끄면 대상 초기화
      end
   end,
})

MainTab:CreateButton({
   Name = "현재 타겟 초기화",
   Callback = function()
      AutoLoopTarget = nil
      Rayfield:Notify({Title = "알림", Content = "루프 대상을 초기화했습니다. 다시 잡으세요!"})
   end,
})

-- 킬 그랩 (원본 파일 로직 동일)
local KillGrabEnabled = false
MainTab:CreateToggle({
   Name = "킬 그랩 (잡히면 즉시 처단)",
   CurrentValue = false,
   Callback = function(Value)
      KillGrabEnabled = Value
   end,
})

task.spawn(function()
    while task.wait() do
        if KillGrabEnabled then
            local grabParts = workspace:FindFirstChild("GrabParts")
            if grabParts then
                for _, gp in pairs(grabParts:GetChildren()) do
                    local weld = gp:FindFirstChildOfClass("WeldConstraint")
                    if weld and weld.Part1 and weld.Part1:IsDescendantOf(workspace) then
                        local attacker = weld.Part1:FindFirstAncestorOfClass("Model")
                        if attacker and attacker ~= plr.Character then
                            local root = attacker:FindFirstChild("HumanoidRootPart") or attacker:FindFirstChild("Torso")
                            if root then
                                root.CFrame = CFrame.new(root.Position.X, targetY, root.Position.Z)
                                weld:Destroy()
                            end
                        end
                    end
                end
            end
        end
    end
end)

Rayfield:Notify({Title = "로딩 완료", Content = "대상을 직접 잡으면 루프가 시작됩니다!"})
